<div class="container mx-auto px-4 py-8">
  <!-- Header -->
  <div class="flex justify-between items-center mb-8">
    <div>
      <h1 class="text-4xl font-bold"><%= campaign.name %></h1>
      <div class="flex items-center gap-4 mt-2">
        <!-- Status Badge -->
        <span class="px-3 py-1 text-sm font-semibold rounded-full <%=
          campaign.status === 'draft' ? 'bg-gray-100 text-gray-800' :
          campaign.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
          campaign.status === 'approved' ? 'bg-green-100 text-green-800' :
          'bg-red-100 text-red-800'
        %>">
          <%= campaign.status === 'pending' ? 'Pending Approval' :
              campaign.status.charAt(0).toUpperCase() + campaign.status.slice(1) %>
        </span>
      </div>
    </div>
    <div class="flex gap-2">
      <a href="/campaigns" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 font-semibold">
        ‚Üê Back
      </a>
      <% if (campaign.status === 'draft') { %>
        <button onclick="editCampaign()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
          Edit
        </button>
      <% } %>
      <button onclick="deleteCampaignDetail()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">
        Delete
      </button>
    </div>
  </div>

  <!-- Loan Factory Warning -->
  <% if (workspace.name === 'Loan Factory') { %>
    <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
      <p class="text-yellow-800">
        <strong>Note:</strong> This is a Loan Factory campaign and may require approval before sending.
      </p>
    </div>
  <% } %>

  <!-- Main Grid -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left Column: Main Content -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Campaign Basics -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold mb-4">Campaign Details</h2>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <p class="text-sm text-gray-600">Type</p>
            <p class="text-lg font-semibold">
              <%= campaign.type === 'one-off' ? 'One-Off' :
                  campaign.type === 'scheduled' ? 'Scheduled' : 'Drip' %>
            </p>
          </div>
          <div>
            <p class="text-sm text-gray-600">Workspace</p>
            <p class="text-lg font-semibold"><%= workspace.name %></p>
          </div>
          <div>
            <p class="text-sm text-gray-600">Created</p>
            <p class="text-lg font-semibold">
              <% const createdDate = new Date(campaign.created_at); %>
              <%= createdDate.toLocaleDateString() %>
            </p>
          </div>
          <div>
            <p class="text-sm text-gray-600">Last Updated</p>
            <p class="text-lg font-semibold">
              <% const updatedDate = new Date(campaign.updated_at); %>
              <%= updatedDate.toLocaleDateString() %>
            </p>
          </div>
        </div>
      </div>

      <!-- Template Section -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold">Email Template</h2>
          <% if (campaign.status === 'draft') { %>
            <button onclick="openEditTemplateModal()" class="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm font-semibold">
              Change Template
            </button>
          <% } %>
        </div>

        <% if (campaign.template) { %>
          <div class="border-l-4 border-blue-500 pl-4">
            <p class="font-semibold text-gray-900"><%= campaign.template.name %></p>
            <p class="text-sm text-gray-600 mt-2">Type: <%= campaign.template.template_type %></p>
            <% if (campaign.template.subject) { %>
              <p class="text-sm text-gray-700 mt-2"><strong>Subject:</strong> <%= campaign.template.subject %></p>
            <% } %>
            <% if (campaign.template.preheader) { %>
              <p class="text-sm text-gray-700"><strong>Preheader:</strong> <%= campaign.template.preheader %></p>
            <% } %>
          </div>
        <% } else { %>
          <p class="text-gray-500 italic">No template selected - email will be composed when sending</p>
        <% } %>
      </div>

      <!-- Recipients Section -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold">Recipients</h2>
          <% if (campaign.status === 'draft') { %>
            <button onclick="openEditSegmentModal()" class="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm font-semibold">
              Edit Recipients
            </button>
          <% } %>
        </div>

        <% if (campaign.segment) { %>
          <div class="space-y-3">
            <p><strong>Segment Type:</strong>
              <%=
                campaign.segment.type === 'whole_list' ? 'All contacts in a list' :
                campaign.segment.type === 'filtered' ? 'Filtered contacts' :
                'Manually selected'
              %>
            </p>
            <% if (campaign.segment.listId) { %>
              <p><strong>List:</strong>
                <% const list = lists.find(l => l.id === campaign.segment.listId); %>
                <%= list ? list.name : 'List #' + campaign.segment.listId %>
              </p>
            <% } %>
            <% if (campaign.segment.filters && campaign.segment.filters.length > 0) { %>
              <p><strong>Filters Applied:</strong> <%= campaign.segment.filters.length %> filter(s)</p>
            <% } %>
            <% if (campaign.segment.contactIds && campaign.segment.contactIds.length > 0) { %>
              <p><strong>Selected Contacts:</strong> <%= campaign.segment.contactIds.length %> contact(s)</p>
            <% } %>
          </div>
        <% } else { %>
          <p class="text-gray-500 italic">No segment defined yet</p>
        <% } %>
      </div>

      <!-- Schedule Section -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold">Schedule</h2>
          <% if (campaign.status === 'draft') { %>
            <button onclick="openEditScheduleModal()" class="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm font-semibold">
              Edit Schedule
            </button>
          <% } %>
        </div>

        <% if (campaign.schedule) { %>
          <div class="space-y-3">
            <p><strong>Schedule Type:</strong>
              <%=
                campaign.schedule.type === 'immediate' ? 'Send immediately' :
                campaign.schedule.type === 'once' ? 'Send on specific date' :
                'Drip campaign'
              %>
            </p>
            <% if (campaign.schedule.sendAt) { %>
              <p><strong>Send Date/Time:</strong>
                <% const sendDate = new Date(campaign.schedule.sendAt); %>
                <%= sendDate.toLocaleString() %>
              </p>
            <% } %>
            <% if (campaign.schedule.steps && campaign.schedule.steps.length > 0) { %>
              <div>
                <strong>Drip Steps:</strong>
                <ul class="mt-2 space-y-2">
                  <% campaign.schedule.steps.forEach((step, idx) => { %>
                    <li class="text-sm border-l-2 border-gray-300 pl-3">
                      <strong>Step <%= idx + 1 %>:</strong> <%= step.delay %> hour(s) delay - <%= step.templateId ? 'Template #' + step.templateId : 'No template' %>
                    </li>
                  <% }); %>
                </ul>
              </div>
            <% } %>
          </div>
        <% } else { %>
          <p class="text-gray-500 italic">No schedule defined yet</p>
        <% } %>
      </div>
    </div>

    <!-- Right Column: Approval & Status -->
    <div class="space-y-6">
      <!-- Approval Section (Loan Factory only) -->
      <% if (workspace.name === 'Loan Factory' && campaign.approval) { %>
        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 <%=
          campaign.approval.status === 'pending' ? 'border-yellow-500' :
          campaign.approval.status === 'approved' ? 'border-green-500' :
          'border-red-500'
        %>">
          <h2 class="text-xl font-bold mb-4">Approval Workflow</h2>

          <div class="mb-4">
            <p class="text-sm text-gray-600">Status</p>
            <p class="text-lg font-semibold">
              <%= campaign.approval.status === 'pending' ? 'Awaiting Approval' :
                  campaign.approval.status === 'approved' ? 'Approved' :
                  'Rejected' %>
            </p>
          </div>

          <% if (campaign.approval.reviewed_at) { %>
            <div class="mb-4">
              <p class="text-sm text-gray-600">Reviewed</p>
              <% const reviewedDate = new Date(campaign.approval.reviewed_at); %>
              <p class="text-lg font-semibold"><%= reviewedDate.toLocaleString() %></p>
            </div>
          <% } %>

          <% if (campaign.approval.notes) { %>
            <div class="mb-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
              <p class="text-sm text-gray-600 mb-2">Notes</p>
              <p class="text-gray-800"><%= campaign.approval.notes %></p>
            </div>
          <% } %>

          <!-- Approval Buttons (Loan Factory leads only) -->
          <% if (campaign.status === 'pending') { %>
            <div class="flex gap-2">
              <button onclick="approveCampaignDetail()" class="flex-1 px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold text-sm">
                Approve
              </button>
              <button onclick="rejectCampaignDetail()" class="flex-1 px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold text-sm">
                Reject
              </button>
            </div>
          <% } %>
        </div>
      <% } %>

      <!-- Quick Actions -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-bold mb-4">Quick Actions</h2>
        <div class="space-y-2">
          <% if (campaign.status === 'draft') { %>
            <button onclick="sendTestEmail()" class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold text-sm">
              Send Test Email
            </button>
          <% } %>

          <% if (campaign.status === 'approved') { %>
            <button onclick="sendCampaign()" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold text-sm">
              Send Campaign
            </button>
          <% } %>

          <% if (campaign.status === 'pending') { %>
            <p class="text-sm text-yellow-700 p-2 bg-yellow-50 rounded-lg text-center">
              Awaiting approval to send
            </p>
          <% } %>

          <% if (campaign.status === 'draft') { %>
            <button onclick="previewCampaign()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold text-sm">
              Preview Campaign
            </button>
          <% } %>
        </div>
      </div>

      <!-- Campaign Info Card -->
      <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
        <h3 class="font-semibold text-gray-900 mb-3">Campaign ID</h3>
        <p class="text-sm text-gray-600 font-mono break-all"><%= campaign.id %></p>
      </div>
    </div>
  </div>
</div>

<!-- Edit Template Modal -->
<div id="editTemplateModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4">
    <h2 class="text-2xl font-bold mb-4">Change Template</h2>
    <form onsubmit="submitEditTemplate(event)">
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Template</label>
        <select id="editTemplateSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">No template</option>
          <% templates.forEach(template => { %>
            <option value="<%= template.id %>" <%if (campaign.template_id === template.id) { %>selected<% } %>>
              <%= template.name %>
            </option>
          <% }); %>
        </select>
      </div>

      <div class="flex gap-2 justify-end">
        <button type="button" onclick="closeEditTemplateModal()" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
          Cancel
        </button>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
          Update
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Segment Modal (placeholder) -->
<div id="editSegmentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4">
    <h2 class="text-2xl font-bold mb-4">Edit Recipients</h2>
    <p class="text-gray-700 mb-4">Advanced recipient management will be available in a future update. For now, please create a new campaign to change recipients.</p>
    <div class="flex justify-end gap-2">
      <button type="button" onclick="closeEditSegmentModal()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold">
        Close
      </button>
    </div>
  </div>
</div>

<!-- Edit Schedule Modal (placeholder) -->
<div id="editScheduleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4">
    <h2 class="text-2xl font-bold mb-4">Edit Schedule</h2>
    <p class="text-gray-700 mb-4">Advanced schedule management will be available in a future update. For now, please create a new campaign to change the schedule.</p>
    <div class="flex justify-end gap-2">
      <button type="button" onclick="closeEditScheduleModal()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold">
        Close
      </button>
    </div>
  </div>
</div>

<!-- Approve Campaign Modal -->
<div id="approveCampaignDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4">
    <h2 class="text-2xl font-bold mb-4">Approve Campaign</h2>
    <p class="text-gray-700 mb-4">Are you sure you want to approve <strong><%= campaign.name %></strong>?</p>
    <form onsubmit="submitApproveCampaignDetail(event)">
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Approval Notes (Optional)</label>
        <textarea id="approveDetailsNotes" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" rows="4" placeholder="Add approval notes..."></textarea>
      </div>

      <div class="flex gap-2 justify-end">
        <button type="button" onclick="closeApproveCampaignDetailModal()" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
          Cancel
        </button>
        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
          Approve
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Reject Campaign Modal -->
<div id="rejectCampaignDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4">
    <h2 class="text-2xl font-bold mb-4">Reject Campaign</h2>
    <p class="text-gray-700 mb-4">Are you sure you want to reject <strong><%= campaign.name %></strong>?</p>
    <form onsubmit="submitRejectCampaignDetail(event)">
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Rejection Reason</label>
        <textarea id="rejectDetailsNotes" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" rows="4" placeholder="Explain why this campaign is being rejected..." required></textarea>
      </div>

      <div class="flex gap-2 justify-end">
        <button type="button" onclick="closeRejectCampaignDetailModal()" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
          Cancel
        </button>
        <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">
          Reject
        </button>
      </div>
    </form>
  </div>
</div>

<script>
const campaignId = <%= campaign.id %>;

// Modal functions
function openEditTemplateModal() {
  document.getElementById('editTemplateModal').classList.remove('hidden');
}

function closeEditTemplateModal() {
  document.getElementById('editTemplateModal').classList.add('hidden');
}

function openEditSegmentModal() {
  document.getElementById('editSegmentModal').classList.remove('hidden');
}

function closeEditSegmentModal() {
  document.getElementById('editSegmentModal').classList.add('hidden');
}

function openEditScheduleModal() {
  document.getElementById('editScheduleModal').classList.remove('hidden');
}

function closeEditScheduleModal() {
  document.getElementById('editScheduleModal').classList.add('hidden');
}

function approveCampaignDetail() {
  document.getElementById('approveCampaignDetailModal').classList.remove('hidden');
}

function closeApproveCampaignDetailModal() {
  document.getElementById('approveCampaignDetailModal').classList.add('hidden');
}

function rejectCampaignDetail() {
  document.getElementById('rejectCampaignDetailModal').classList.remove('hidden');
}

function closeRejectCampaignDetailModal() {
  document.getElementById('rejectCampaignDetailModal').classList.add('hidden');
}

// Campaign actions
function editCampaign() {
  window.location.href = '/campaigns/new'; // In future, implement edit form
  // For now, user can delete and recreate
}

function deleteCampaignDetail() {
  if (!confirm('Are you sure you want to delete this campaign? This cannot be undone.')) return;

  fetch('/api/campaigns/' + campaignId, { method: 'DELETE' })
    .then(r => r.json())
    .then(data => {
      if (data.error) {
        alert('Error: ' + data.error.message);
      } else {
        window.location.href = '/campaigns';
      }
    })
    .catch(err => alert('Failed to delete campaign: ' + err.message));
}

function submitEditTemplate(event) {
  event.preventDefault();

  const templateId = document.getElementById('editTemplateSelect').value || null;

  fetch('/api/campaigns/' + campaignId, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ templateId: templateId ? parseInt(templateId) : null })
  })
  .then(r => r.json())
  .then(data => {
    if (data.error) {
      alert('Error: ' + data.error.message);
    } else {
      closeEditTemplateModal();
      location.reload();
    }
  })
  .catch(err => alert('Failed to update template: ' + err.message));
}

function submitApproveCampaignDetail(event) {
  event.preventDefault();

  const notes = document.getElementById('approveDetailsNotes').value;

  fetch('/api/campaigns/' + campaignId + '/approve', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ notes })
  })
  .then(r => r.json())
  .then(data => {
    if (data.error) {
      alert('Error: ' + data.error.message);
    } else {
      closeApproveCampaignDetailModal();
      location.reload();
    }
  })
  .catch(err => alert('Failed to approve campaign: ' + err.message));
}

function submitRejectCampaignDetail(event) {
  event.preventDefault();

  const notes = document.getElementById('rejectDetailsNotes').value;

  fetch('/api/campaigns/' + campaignId + '/reject', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ notes })
  })
  .then(r => r.json())
  .then(data => {
    if (data.error) {
      alert('Error: ' + data.error.message);
    } else {
      closeRejectCampaignDetailModal();
      location.reload();
    }
  })
  .catch(err => alert('Failed to reject campaign: ' + err.message));
}

function sendTestEmail() {
  alert('Test email functionality coming soon!');
}

function sendCampaign() {
  if (!confirm('Send this campaign now?')) return;
  alert('Campaign sending functionality coming soon!');
}

function previewCampaign() {
  alert('Campaign preview functionality coming soon!');
}
</script>
