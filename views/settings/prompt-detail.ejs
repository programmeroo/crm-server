<div class="container mx-auto px-4 py-6">
  <!-- Breadcrumb -->
  <div class="mb-6 text-sm text-gray-600">
    <a href="/settings" class="text-blue-600 hover:text-blue-800">Settings</a>
    <span class="mx-2">/</span>
    <span class="text-blue-600 hover:text-blue-800 cursor-pointer" onclick="location.href='/settings#prompts'">Prompts</span>
    <span class="mx-2">/</span>
    <span class="font-medium text-gray-800"><%= prompt.name %></span>
  </div>

  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-3xl font-bold text-gray-800"><%= prompt.name %></h1>
    <div class="flex gap-3">
      <button
        onclick="savePrompt()"
        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
      >
        Save Changes
      </button>
      <button
        onclick="deletePrompt()"
        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition"
      >
        Delete
      </button>
    </div>
  </div>

  <!-- Error/Success Messages -->
  <div id="messageDiv" class="mb-6 hidden"></div>

  <div class="grid grid-cols-3 gap-6">
    <!-- Main Edit Area (2/3) -->
    <div class="col-span-2 space-y-6">
      <!-- Name -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Prompt Name</label>
        <input
          type="text"
          id="promptName"
          value="<%= prompt.name %>"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
      </div>

      <!-- Description -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
        <input
          type="text"
          id="promptDescription"
          value="<%= prompt.description || '' %>"
          placeholder="Optional description"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
      </div>

      <!-- Content -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Prompt Content</label>
        <textarea
          id="promptContent"
          rows="16"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
        ><%= prompt.content %></textarea>
        <p class="text-xs text-gray-500 mt-2">Markdown formatting is supported</p>
      </div>
    </div>

    <!-- Sidebar (1/3) -->
    <div class="space-y-6">
      <!-- Info Card -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Information</h3>

        <div class="space-y-3">
          <!-- Workspace -->
          <div>
            <p class="text-xs font-semibold text-gray-600 uppercase">Workspace</p>
            <p class="text-gray-800">
              <span class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">
                <%= workspace.name %>
              </span>
            </p>
          </div>

          <!-- List -->
          <div>
            <p class="text-xs font-semibold text-gray-600 uppercase">List</p>
            <p class="text-gray-800">
              <% if (prompt.listId && listName) { %>
                <span class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">
                  <%= listName %>
                </span>
              <% } else if (prompt.listId) { %>
                <span class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">
                  List <%= prompt.listId %>
                </span>
              <% } else { %>
                <span class="inline-block bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-sm">
                  All Lists
                </span>
              <% } %>
            </p>
          </div>

          <!-- Divider -->
          <hr class="my-4" />

          <!-- Created -->
          <div>
            <p class="text-xs font-semibold text-gray-600 uppercase">Created</p>
            <p class="text-gray-700 text-sm">
              <% const createdDate = new Date(prompt.createdAt); %>
              <%= createdDate.toLocaleDateString() %> at <%= createdDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %>
            </p>
          </div>

          <!-- Updated -->
          <div>
            <p class="text-xs font-semibold text-gray-600 uppercase">Last Updated</p>
            <p class="text-gray-700 text-sm">
              <% const updatedDate = new Date(prompt.updatedAt); %>
              <%= updatedDate.toLocaleDateString() %> at <%= updatedDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %>
            </p>
          </div>

          <!-- Filename -->
          <div>
            <p class="text-xs font-semibold text-gray-600 uppercase">File</p>
            <p class="text-gray-700 text-sm font-mono break-all">
              <%= prompt.filename %>
            </p>
          </div>
        </div>
      </div>

      <!-- File Info Card -->
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <p class="text-xs text-blue-800">
          <strong>ðŸ’¾ File-Based Storage:</strong> This prompt is stored as a markdown file. You can edit it directly in VS Code at <code class="bg-blue-100 px-1 rounded">data/prompts/</code>.
        </p>
      </div>
    </div>
  </div>
</div>

<script>
  const filename = '<%- prompt.filename %>';
  const workspaceId = <%= prompt.workspaceId %>;

  async function savePrompt() {
    const name = document.getElementById('promptName').value;
    const description = document.getElementById('promptDescription').value;
    const content = document.getElementById('promptContent').value;

    if (!name || !content) {
      showMessage('Please fill in required fields', 'error');
      return;
    }

    try {
      const response = await fetch(`/api/prompts/${filename}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name,
          description: description || null,
          content,
        }),
      });

      if (!response.ok) {
        const error = await response.json();
        showMessage('Error: ' + (error.error || 'Failed to save'), 'error');
        return;
      }

      const result = await response.json();
      showMessage('Prompt saved successfully!', 'success');

      // If filename changed (name was updated), redirect to new filename
      if (result.data.filename !== filename) {
        setTimeout(() => {
          window.location.href = `/settings/prompts/${result.data.filename}`;
        }, 1000);
      }
    } catch (err) {
      showMessage('Error: ' + err.message, 'error');
    }
  }

  async function deletePrompt() {
    if (!confirm('Are you sure you want to delete this prompt? This cannot be undone.')) {
      return;
    }

    try {
      const response = await fetch(`/api/prompts/${filename}`, {
        method: 'DELETE',
      });

      if (!response.ok) {
        const error = await response.json();
        showMessage('Error: ' + (error.error || 'Failed to delete'), 'error');
        return;
      }

      showMessage('Prompt deleted. Redirecting...', 'success');
      setTimeout(() => {
        window.location.href = '/settings';
      }, 1000);
    } catch (err) {
      showMessage('Error: ' + err.message, 'error');
    }
  }

  function showMessage(message, type) {
    const div = document.getElementById('messageDiv');
    div.textContent = message;
    div.className = `mb-6 p-4 rounded-lg ${
      type === 'success'
        ? 'bg-green-100 text-green-800 border border-green-300'
        : 'bg-red-100 text-red-800 border border-red-300'
    }`;
    div.classList.remove('hidden');

    // Auto-hide success messages
    if (type === 'success') {
      setTimeout(() => {
        div.classList.add('hidden');
      }, 3000);
    }
  }
</script>
