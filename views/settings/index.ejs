<div class="container mx-auto px-4 py-6">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-3xl font-bold text-gray-800">Settings</h1>
  </div>

  <!-- Tabs -->
  <div class="mb-6 border-b border-gray-300">
    <div class="flex gap-6">
      <button
        class="px-4 py-2 font-semibold text-gray-800 border-b-2 border-blue-600"
        onclick="switchTab('prompts')"
      >
        Prompts
      </button>
      <button
        class="px-4 py-2 font-semibold text-gray-500 border-b-2 border-transparent hover:text-gray-800"
        onclick="switchTab('other')"
      >
        Other Settings
      </button>
    </div>
  </div>

  <!-- Prompts Tab -->
  <div id="prompts-tab">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold text-gray-800">Prompts Library</h2>
      <button
        onclick="openCreateModal()"
        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
      >
        + New Prompt
      </button>
    </div>

    <!-- Filters -->
    <div class="mb-6 flex gap-4 items-end">
      <div class="flex-1">
        <label class="block text-sm font-medium text-gray-700 mb-1">Workspace</label>
        <select
          id="workspaceFilter"
          onchange="updateListDropdown(); applyFilters();"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
        >
          <option value="">All Workspaces</option>
          <% workspaces.forEach(ws => { %>
            <option value="<%= ws.id %>"><%= ws.name %></option>
          <% }); %>
        </select>
      </div>
      <div class="flex-1">
        <label class="block text-sm font-medium text-gray-700 mb-1">List</label>
        <select
          id="listFilter"
          onchange="applyFilters()"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
        >
          <option value="">All Lists</option>
        </select>
      </div>
      <button
        onclick="clearFilters()"
        class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition"
      >
        Clear
      </button>
    </div>

    <!-- Search -->
    <div class="mb-6">
      <input
        type="text"
        id="searchInput"
        placeholder="Search prompts by name..."
        onkeyup="applyFilters()"
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
      />
    </div>

    <!-- Prompts Table -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
      <table class="w-full">
        <thead class="bg-gray-100 border-b border-gray-300">
          <tr>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Name</th>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Workspace</th>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">List</th>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Last Updated</th>
            <th class="px-6 py-3 text-center text-sm font-semibold text-gray-700">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          <% prompts.forEach(prompt => { %>
            <tr
              class="prompt-row hover:bg-gray-50"
              data-workspace-id="<%= prompt.workspaceId %>"
              data-list-id="<%= prompt.listId || '' %>"
              data-name="<%= prompt.name.toLowerCase() %>"
            >
              <td class="px-6 py-4 text-gray-900 font-medium"><%= prompt.name %></td>
              <td class="px-6 py-4 text-gray-600"><%= prompt.workspaceName %></td>
              <td class="px-6 py-4 text-gray-600">
                <% if (prompt.listId && prompt.listName) { %>
                  <span class="text-gray-700"><%= prompt.listName %></span>
                <% } else if (prompt.listId) { %>
                  <span class="text-gray-700">(List <%= prompt.listId %>)</span>
                <% } else { %>
                  <span class="text-gray-500 italic">All Lists</span>
                <% } %>
              </td>
              <td class="px-6 py-4 text-gray-600 text-sm">
                <% const date = new Date(prompt.updatedAt); %>
                <%= date.toLocaleDateString() %> <%= date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %>
              </td>
              <td class="px-6 py-4 text-center">
                <a
                  href="/settings/prompts/<%= prompt.filename %>"
                  class="text-green-600 hover:text-green-800 mr-4"
                  title="Edit"
                >
                  ‚úèÔ∏è
                </a>
                <button
                  onclick="deletePrompt('<%= prompt.filename %>')"
                  class="text-red-600 hover:text-red-800"
                  title="Delete"
                >
                  üóëÔ∏è
                </button>
              </td>
            </tr>
          <% }); %>
          <% if (prompts.length === 0) { %>
            <tr>
              <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                No prompts yet. Click "New Prompt" to create one.
              </td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Other Settings Tab (placeholder) -->
  <div id="other-tab" class="hidden">
    <div class="bg-white rounded-lg shadow-md p-6">
      <p class="text-gray-600">Additional settings coming soon...</p>
    </div>
  </div>
</div>

<!-- Create Prompt Modal -->
<div
  id="createModal"
  class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
>
  <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">Create New Prompt</h2>

    <form onsubmit="submitCreateForm(event)">
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Workspace *</label>
        <select
          id="createWorkspaceId"
          onchange="updateCreateListDropdown()"
          required
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
        >
          <option value="">Select a workspace</option>
          <% workspaces.forEach(ws => { %>
            <option value="<%= ws.id %>"><%= ws.name %></option>
          <% }); %>
        </select>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">List (Optional)</label>
        <select
          id="createListId"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
        >
          <option value="">All Lists (workspace-wide)</option>
        </select>
        <p class="text-xs text-gray-500 mt-1">Leave as "All Lists" for workspace-wide prompts, or select a specific list</p>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Prompt Name *</label>
        <input
          type="text"
          id="createName"
          required
          placeholder="e.g., CA Dreamers Program 1"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
        <input
          type="text"
          id="createDescription"
          placeholder="Optional description"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
      </div>

      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-1">Prompt Content *</label>
        <textarea
          id="createContent"
          required
          placeholder="Enter your prompt here..."
          rows="8"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
        ></textarea>
      </div>

      <div class="flex gap-3 justify-end">
        <button
          type="button"
          onclick="closeCreateModal()"
          class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition"
        >
          Cancel
        </button>
        <button
          type="submit"
          class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
        >
          Create
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  const allWorkspaces = <%- JSON.stringify(workspaces) %>;
  const allPrompts = <%- JSON.stringify(prompts) %>;
  const workspaceLists = <%- JSON.stringify(workspaceLists) %>;

  function switchTab(tab) {
    // Hide all tabs
    document.getElementById('prompts-tab').classList.add('hidden');
    document.getElementById('other-tab').classList.add('hidden');

    // Show selected tab
    document.getElementById(tab + '-tab').classList.remove('hidden');

    // Update button styles
    document.querySelectorAll('button[onclick^="switchTab"]').forEach(btn => {
      btn.classList.remove('border-blue-600', 'text-gray-800');
      btn.classList.add('border-transparent', 'text-gray-500');
    });
    event.target.classList.add('border-blue-600', 'text-gray-800');
    event.target.classList.remove('border-transparent', 'text-gray-500');
  }

  function openCreateModal() {
    document.getElementById('createModal').classList.remove('hidden');
  }

  function closeCreateModal() {
    document.getElementById('createModal').classList.add('hidden');
    document.getElementById('createWorkspaceId').value = '';
    document.getElementById('createListId').innerHTML = '<option value="">All Lists (workspace-wide)</option>';
    document.getElementById('createName').value = '';
    document.getElementById('createDescription').value = '';
    document.getElementById('createContent').value = '';
  }

  // Update list dropdown when workspace is selected in create form
  function updateCreateListDropdown() {
    const workspaceId = parseInt(document.getElementById('createWorkspaceId').value);
    const listSelect = document.getElementById('createListId');
    listSelect.innerHTML = '<option value="">All Lists (workspace-wide)</option>';

    if (!workspaceId || !workspaceLists[workspaceId]) return;

    // Get lists for this workspace
    const listsForWorkspace = workspaceLists[workspaceId] || [];
    listsForWorkspace.forEach(list => {
      const option = document.createElement('option');
      option.value = list.id;
      option.textContent = list.name;
      listSelect.appendChild(option);
    });
  }

  // Update list dropdown in filter when workspace is selected
  function updateListDropdown() {
    const workspaceId = parseInt(document.getElementById('workspaceFilter').value);
    const listSelect = document.getElementById('listFilter');
    listSelect.innerHTML = '<option value="">All Lists</option>';

    if (!workspaceId || !workspaceLists[workspaceId]) {
      applyFilters();
      return;
    }

    // Get lists for this workspace
    const listsForWorkspace = workspaceLists[workspaceId] || [];
    listsForWorkspace.forEach(list => {
      const option = document.createElement('option');
      option.value = list.id;
      option.textContent = list.name;
      listSelect.appendChild(option);
    });

    applyFilters();
  }

  async function submitCreateForm(event) {
    event.preventDefault();

    const workspaceId = document.getElementById('createWorkspaceId').value;
    const listId = document.getElementById('createListId').value;
    const name = document.getElementById('createName').value;
    const description = document.getElementById('createDescription').value;
    const content = document.getElementById('createContent').value;

    if (!workspaceId || !name || !content) {
      alert('Please fill in required fields');
      return;
    }

    try {
      const response = await fetch('/api/prompts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          workspaceId: parseInt(workspaceId),
          listId: listId ? parseInt(listId) : null,
          name,
          description: description || null,
          content,
        }),
      });

      if (!response.ok) {
        const error = await response.json();
        alert('Error: ' + (error.error || 'Failed to create prompt'));
        return;
      }

      closeCreateModal();
      location.reload();
    } catch (err) {
      alert('Error: ' + err.message);
    }
  }

  function applyFilters() {
    const workspaceFilter = document.getElementById('workspaceFilter').value;
    const listFilter = document.getElementById('listFilter').value;
    const searchInput = document.getElementById('searchInput').value.toLowerCase();

    const rows = document.querySelectorAll('.prompt-row');
    rows.forEach(row => {
      const workspaceId = row.getAttribute('data-workspace-id');
      const listId = row.getAttribute('data-list-id');
      const name = row.getAttribute('data-name');

      const matchWorkspace = !workspaceFilter || workspaceId === workspaceFilter;
      const matchList = !listFilter || listId === listFilter;
      const matchSearch = name.includes(searchInput);

      row.style.display = matchWorkspace && matchList && matchSearch ? '' : 'none';
    });
  }

  function clearFilters() {
    document.getElementById('workspaceFilter').value = '';
    document.getElementById('listFilter').innerHTML = '<option value="">All Lists</option>';
    document.getElementById('searchInput').value = '';
    applyFilters();
  }

  async function deletePrompt(filename) {
    if (!confirm('Are you sure you want to delete this prompt?')) {
      return;
    }

    try {
      const response = await fetch(`/api/prompts/${filename}`, {
        method: 'DELETE',
      });

      if (!response.ok) {
        const error = await response.json();
        alert('Error: ' + (error.error || 'Failed to delete prompt'));
        return;
      }

      location.reload();
    } catch (err) {
      alert('Error: ' + err.message);
    }
  }
</script>
